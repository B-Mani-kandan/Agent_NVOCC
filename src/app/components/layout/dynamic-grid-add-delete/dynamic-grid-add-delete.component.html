<form [formGroup]="form">
  <div class="mat-elevation-z8 mt-4">
    <div formArrayName="rows">
      <table mat-table [dataSource]="rows.controls" class="mat-table">
        <ng-container *ngFor="let field of fields" [matColumnDef]="field.id">
          <th mat-header-cell *matHeaderCellDef>{{ field.label }}</th>
          <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
            <input
              *ngIf="field.type === 'text' || field.type === 'date'"
              matInput
              [type]="field.type"
              [placeholder]="field.label"
              [formControlName]="field.id"
              [readonly]="field.readonly || false"
            />
            <mat-select
              *ngIf="field.type === 'select'"
              [formControlName]="field.id"
            >
              <mat-option *ngFor="let opt of field.options" [value]="opt">
                {{ opt }}
              </mat-option>
            </mat-select>
            <mat-form-field *ngIf="field.type === 'autocomplete'">
              <input
                type="text"
                matInput
                [placeholder]="field.label"
                [formControlName]="field.id"
                [matAutocomplete]="auto"
                [readonly]="field.readonly || false"
              />
              <mat-autocomplete #auto="matAutocomplete">
                <mat-option
                  *ngFor="let opt of row.get(field.id)['options'] || []"
                  [value]="opt"
                >
                  {{ opt }}
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let row; let i = index">
            <button
              mat-icon-button
              style="color: red"
              (click)="removeRow(i)"
              [disabled]="rows.length === 1"
            >
              <i class="ri-delete-bin-6-line"></i>
            </button>
            <button
              mat-icon-button
              color="primary"
              style="color: #3d5095"
              *ngIf="i === rows.length - 1"
              (click)="addRow()"
            >
              <i class="ri-add-circle-line"></i>
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
  </div>
</form>
